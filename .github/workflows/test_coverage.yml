# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Test Coverage

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze project source
        run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      # ✅ Extract coverage percentage and create badge JSON
      - name: Generate coverage badge
        run: |
          sudo apt-get update && sudo apt-get install -y lcov bc
          
          # Parse total line coverage percentage
          COVERAGE=$(lcov --summary coverage/lcov.info 2>/dev/null | grep 'lines' | tail -1 | awk '{print $2}' | sed 's/%//')
          
          # Fallback if parsing fails
          if [ -z "$COVERAGE" ]; then
            echo "⚠️ Coverage not found, defaulting to 0"
            COVERAGE=0
          fi

          echo "Coverage is ${COVERAGE}%"
          
          # Choose color based on coverage percentage
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            COLOR=red
          elif (( $(echo "$COVERAGE < 80" | bc -l) )); then
            COLOR=yellow
          else
            COLOR=green
          fi

          # Generate shields.io JSON file
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${COVERAGE}%\",\"color\":\"${COLOR}\"}" > coverage-badge.json
