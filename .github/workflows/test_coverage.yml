# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Test Coverage

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze project source
        run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      # âœ… Extract coverage percentage and create badge JSON
      - name: Generate coverage badge
        run: |
          # Parse total coverage percentage
          COVERAGE=$(lcov --summary coverage/lcov.info 2>/dev/null | grep 'lines......:' | awk '{print substr($2, 1, length($2)-1)}')

          echo "Coverage is ${COVERAGE}%"

          # Generate shields.io-style JSON
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${COVERAGE}%\",\"color\":\"$(if (( $(echo "$COVERAGE < 50" | bc -l) )); then echo red; elif (( $(echo "$COVERAGE < 80" | bc -l) )); then echo yellow; else echo green; fi)\"}" > coverage-badge.json
